# Malware Gateway

- VMWare Fusion
- Ubuntu 14.04.02
- Zentyal 4.0 Community Edition

## Setup VMWare Fusion
First, create a new network that *only* allows virtual machines to talk to other virtual machines. This prevents malware
from talking to our local network, or our host.

    Preferences -> Network -> Unlock -> + -> vmnet2
    - Uncheck "Allow virtual machines on this network to connect to external networks (Using NAT)"
    - Uncheck "Connect the host Mac to this network"
    - Uncheck "Provide address on this network using DHCP"

Next, create a new Ubuntu 14.04.2 virtual machine. Leave the primary network connection bridged, and add a second NIC,
connected to vmnet2.

If you already have your analysis systems setup, set the primary interfaces to use vmnet2 as well.

## Local Domain
For the local domain, I'm using `*.vmlan.internal`.

- http://serverfault.com/questions/17255/top-level-domain-domain-suffix-for-private-network
- http://cr.yp.to/djbdns/dot-local.html


## Initial Configuration
Some initial server setup, to make things a little less painful.

    # update server
    sudo apt-get -y update
    sudo apt-get -y upgrade
    sudo apt-get -y dist-upgrade
    sudo apt-get -y autoclean

    # install openssh-server
    sudo apt-get -y install openssh-server

    # set hostname & reboot
    sudo hostnamectl set-hostname ice
    sudo bash -c 'echo -e "127.0.0.1\tgateway.vmlan.internal\tgateway" >> /etc/hosts'
    sudo reboot

    # now we can ssh in
    ssh-copy-id $server_address
    ssh $server_address

    # build tools & some super-easy environment configuration
    sudo apt-get -y install python-software-properties software-properties-common
    sudo apt-get -y install git-core vim-nox tmux byobu zsh
    curl https://j.mp/spf13-vim3 -L > spf13-vim.sh && sh spf13-vim.sh
    curl -L https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh | sh
    git clone https://github.com/jeremyFreeAgent/oh-my-zsh-powerline-theme.git $HOME/.omzpl
    cd .omzpl && ./install_in_omz.sh
    sed -i 's/robbyrussell/powerline/' $HOME/.zshrc
    chsh -s $(which zsh)
    byobu-enable

TODO: Fix my dotfiles distribution.


## Dashboard
In order to keep our system tidy, I built a small dashboard app that functions as a landing page for quick access to
our applications. To keep things consistent, I configure the applications so that they only listen on the loopback. To
get remote access via the lan interface (*not* the lab interface), I setup a secure nginx proxy. I configure the
loopback interfaces to listen on ports 8080, 8081, 8082, etc - and map the exposed nginx ports to the equivalent 9090,
9091, 9092, etc ...

TODO: Finish dashboard.


## Zentyal Installation
You can install zentyal directly from a downloadable ISO, or on top of Ubuntu. I chose the latter:

    # add zentyal sources & install
    sudo add-apt-repository "deb http://archive.zentyal.org/zentyal 4.0 main extra"
    sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 10E239FF
    wget -q http://keys.zentyal.org/zentyal-4.0-archive.asc -O- | sudo apt-key add -
    sudo apt-get update
    
    # install zentyal core packages
    sudo apt-get -y install zentyal

Once the installation completes zentyal should be running. No reboot should be required. If you're setting it up in
a test vm you'll need to run the installer from the local system, otherwise it'll be become inaccessible during the
installation process - the firewall (by default) will deny all traffic from external networks (as it should) - and the
eth0 (bridged to lan) is the external network.

- Point your web browser to: `https://$SERVER:8443` (use your system credentials to login).
- Select the packages to install and configure:
    - Firewall
    - DHCP Server
    - DNS Server
    - Certification Authority
    - HTTP Proxy
- Network Interfaces:
    - eth0: External, DHCP
    - eth1: Internal, Static (192.168.200.1/24)
- Users and Groups:
    - Server Type: Standalone Server
    - Domain: lab.lan

Once the installation is complete, configure the Firewall to allow all traffic from external networks to zentyal:

    Firewall -> Packet Filter -> External networks to Zentyal -> Configure Rules -> Add New
    Decision:    Accept
    Source:      Any
    Service:     Any
    Description: Allow all external to manage zentyal

And now the interface & ssh can be accessed remotely again.

## DHCP Server
We want to serve DHCP on the LAN to our analysis hosts (so we can turn them on and they *just* work). Enable the  DHCP
server: `Module Status -> DHCP -> 'Status' -> Check`. And configure the DHCP service: `DHCP -> Configuration`:

    Default gateway:    Zentyal
    Search domain:      Zentyal domain, lab.lan
    Primary nameserver: local Zentyal DNS
    NTP server:         local Zentyal NTP
    WINS server:        local Zentyal

And add a range to server DHCP on `Ranges -> Add New`:

    Name:   lab
    From:   192.168.200.100
    To:     192.168.200.200

You're internal VMs should be getting IP address's from Zentyal's DHCP server, however - if you need to troubleshoot:

    sudo apt-get install dhcpdump tcpdump
    sudo dhcpdump -i eth1
    sudo tcpdump -i eth1

## Certificate Authority
`Certification Authority -> General`

    Organization Name:  VMLan, Inc.
    Country Code:       US
    City:               Washington
    State:              District of Columbia
    Days to expire:     3650

http://www.techrepublic.com/blog/smb-technologist/set-up-a-vpn-on-your-zentyal-small-business-server/
http://datacenteroverlords.com/2012/03/01/creating-your-own-ssl-certificate-authority/

## Host Access
Now we want to make sure our host can talk to the lab network (but not vice-versa), so we need to add a route. In my
case, `vmnet2` is actually mapped to the physical interface `vmnet8` (run ifconfig and look for zentyal's bridged
address). We can setup the route for our host using the interface, rather than the address (so this continues to work if
we move our OSX host to some other network):

    # add the host
    sudo route add -net 192.168.200.0/24 -interface vmnet8

    # list routes on osx
    netstat -nr

    # test the route (we should be able to hit it now)
    ping 192.168.200.1

TODO: How to setup hostname to point to interface (not just IP).

    https://superuser.com/questions/72199/address-vmware-fusion-linux-guest-by-hostname
    http://www.craig-wright.com/2012/12/01/vmware-fusion-networking-tips-and-tricks/
    https://apple.stackexchange.com/questions/158117/os-x-10-10-1-etc-hosts-private-etc-hosts-file-is-being-ignored-and-not-resol
    https://stackoverflow.com/questions/87442/virtual-network-interface-in-mac-os-x

## Tor

    sudo apt-get -y install git
    sudo apt-get install python-pip python-dev build-essential
    git clone https://github.com/jlund/streisand.git && cd streisand

https://github.com/jlund/streisand
http://www.digitalarmedforces.org/index.php/8-linux/19-how-to-setup-tor-as-a-transparent-proxy-on-ubuntu-linux

## Elk
This setup is using the newly released Kibana 4. Kibana 4 includes its own web server (if you're familiar with Kibana 3,
this is a major change), and access to Kibana must occur through this server. You can't simply just point your existing
webserver at the Kibana directory any longer. One of the difficulties this creates is that we now need a way to start
Kibana's web server if we want to run it as a service - and Kibana doesn't include any init scripts - that part is left
up to the user. In any case, here's a quick setup procedure:

    # install java - it's required by logstash & elasticsearch
    sudo add-apt-repository -y ppa:webupd8team/java
    sudo apt-get -y update
    echo debconf shared/accepted-oracle-license-v1-1 select true | sudo debconf-set-selections
    echo debconf shared/accepted-oracle-license-v1-1 seen true | sudo debconf-set-selections
    sudo apt-get -q -y install oracle-java7-installer
    sudo bash -c "echo JAVA_HOME=/usr/lib/jvm/java-7-oracle/ >> /etc/environment"

    # install elasticsearch 1.4, logstash 1.4 & kibana 4
    sudo bash -c 'wget -O - http://packages.elasticsearch.org/GPG-KEY-elasticsearch | apt-key add -'
    sudo add-apt-repository "deb http://packages.elasticsearch.org/logstash/1.4/debian stable main"
    sudo add-apt-repository "deb http://packages.elasticsearch.org/elasticsearch/1.4/debian stable main"
    sudo apt-get update
    sudo apt-get -y install logstash logstash-contrib elasticsearch
    wget -P /tmp https://download.elasticsearch.org/kibana/kibana/kibana-4.0.0-linux-x64.tar.gz
    sudo tar -zxf /tmp/kibana-4.0.0-linux-x64.tar.gz -C /opt
    sudo mv /opt/kibana-4.0.0-linux-x64 /opt/kibana

    # configure elastic search
    sudo sed -i 's/#cluster.name: elasticsearch/cluster.name: gateway/' /etc/elasticsearch/elasticsearch.yml
    sudo apt-get update && sudo apt-get install elasticsearch
    sudo update-rc.d elasticsearch defaults 95 10
    sudo service elasticsearch restart

    # configure kibana
    https://raw.githubusercontent.com/rackspace-cookbooks/elkstack/master/templates/default/kibana-nginx.conf.erb

    # setup 
    sed -i 's/setuid.*/setuid\ root/g' /etc/init/logstash.conf
    sed -i 's/.*LS_USER.*/LS_USER=root/g' /etc/default/logstash

[elasticsearch]:        http://www.elasticsearch.org/
[logstash]:             http://logstash.net/
[logstash-forwarder]:   https://github.com/elasticsearch/logstash-forwarder
[collectd]:             https://collectd.org/

[es-elasticsearch]:     http://www.elasticsearch.org/overview/elasticsearch
[es-logstash]:          http://www.elasticsearch.org/overview/logstash
[es-kibana]:            http://www.elasticsearch.org/overview/kibana
[es-current]:           http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/setup-repositories.html


<!-- kibana init scripts -->
https://github.com/pbamba/kibana-beta-daemon
https://github.com/akabdog/scripts/blob/master/kibana4_init
https://raw.githubusercontent.com/ariarijp/elasticsearch-and-kibana-playbook/master/files/kibana.initscript


<!-- elk -->
https://raw.githubusercontent.com/terminalcloud/apps/master/elk_installer.sh
https://secure.trifork.com/dl/goto-berlin-2014/GOTO_Night/logstash-kibana-intro.pdf
http://michael.bouvy.net/blog/en/2013/11/19/collect-visualize-your-logs-logstash-elasticsearch-redis-kibana/


<!-- logstash -->
http://kartar.net/2014/09/when-logstash-and-syslog-go-wrong/
http://dopey.io/logstash-learnings.html
http://brewhouse.io/blog/2014/11/04/big-data-with-elk-stack.html
http://jakege.blogspot.com/2014/04/centralized-logging-system-based-on.html


<!-- usage -->
https://mtalavera.wordpress.com/2015/02/16/monitoring-with-collectd-and-kibana/
https://www.timroes.de/2015/02/07/kibana-4-tutorial-part-1-introduction/
https://www.timroes.de/2015/02/07/kibana-4-tutorial-part-2-discover/


http://blog.thekingshotts.com/2015/02/17/opensource-log-aggregation-kibana/
https://stackoverflow.com/questions/20574198/unable-to-proxy-from-nginx-to-kibana
https://stackoverflow.com/questions/27138135/config-settings-for-securing-elasticsearch-with-nginx
http://serverfault.com/questions/633609/configure-nginx-kibana-elasticsearch
http://brudtkuhl.com/securing-elasticsearch/

http://blog.neu5ron.com/2014/12/setup-elasticsearch-logstash-and-kibana.html
http://amsterdam.luminis.eu/2014/12/01/experiment-with-the-kibana-4-beta/
https://gist.github.com/nfarrar/4dc717d49545df017933
https://www.ddreier.com/setting-up-elasticsearch-kibana-and-logstash/
https://www.digitalocean.com/community/tutorials/how-to-use-logstash-and-kibana-to-centralize-and-visualize-logs-on-ubuntu-14-04
https://blog.devita.co/2014/09/04/monitoring-pfsense-firewall-logs-with-elk-logstash-kibana-elasticsearch/
http://everythingshouldbevirtual.com/ubuntu-logstash-server-kibana3-front-end-autoinstall
http://www.ragingcomputer.com/2014/02/monitoring-pfsense-with-logstash-elasticsearch-kibana

<!-- nginx -->
http://www.elasticsearch.org/blog/playing-http-tricks-nginx/

<!-- misc -->

## Bookmarks

    Bookmarks
    https://www.howtoforge.com/zentyal-as-a-gateway-the-perfect-setup
    http://www.linux.org/threads/zentyal-server-%E2%80%93-affordable-all-in-one-server.7081/
    https://github.com/azavea/ansible-kibana

    sudo killall -HUP mDNSResponder
